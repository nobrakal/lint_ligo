\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{hyperref}
\usepackage{minted}
\usepackage{cite}

\author{Alexandre Moine}
\title{Lint ligo development}
\date{September 14, 2020}
\begin{document}
\maketitle

\section{Introduction}

\input{common}

\section{About the components}

\subsection{Deperacted constants}

The analysis is made by a simple traversal of the \verb|Imperative| AST. Indeed, all deprecated constants are marked as such thanks to \url{https://gitlab.com/ligolang/ligo/-/merge_requests/782}.

\subsection{Unused variables}

The analysis is made on the \verb|Typed| AST. The AST is folded to a map linking each variable to a boolean indicating if it was used in the code or not (note that efforts were made to save this information in case of a name capture).
This analysis mimics the one made the OCaml compiler: variables with a name starting by an underscore are not analyzed.\\
Moreover, it is very simple and returns an under-approximation of the whole set of unused variables.
For example with the program:
\begin{minted}{ocaml}
  let x = 42 in
  let y = x  in
  ()
\end{minted}
Only the variable y will be marked as unused because of x being used in the definition of y.

\subsection{Patterns}
Patterns are a way to capture the shape of a piece of code. They are composed of:

\begin{itemize}
\item Pattern variables (identifiers preceded by \verb|%|). Note that a "hole" variable representing an always fresh variable is available using \verb|%_|.
\item To have better control over variables, they can be typed to match only a kind of node in the AST using the syntax \verb|%x:type|. Types depend of the targetted LIGO language.
\item Meta parentheses \verb|%(| \verb|%)|: parentheses not included in the targeted code but useful to indicate the shape of the AST.
\item Any words.
\end{itemize}

More precisely, given a pattern $P$ of type $T$ and a ast $A$, the pattern-matching engine will search a node $N$ of $A$ of type $T$ and a substitution $\sigma$ of the variables in $P$ such that $\sigma(P)$ is equal to $N$.

The pattern matching algorithm is based on the unparsed patterns of Rinderknecht \& Volanschi\cite{unparsedpatterns}. This induces some unusual characteristics:

\begin{itemize}
\item Patterns are \emph{not} parsed, thus they can correspond to invalid LIGO code, and no warning will be issued. Such patterns will simply not match anything.
\item Patterns are not linear, meaning that a variable can appear more than once in a pattern.
\item Variables can be typed. A typed variable will only match a node of the given type.
\end{itemize}

\subsubsection{About unparsed patterns}
The linter ``unparses'' the corresponding CST to a simpler tree and then runs the pattern matching algorithm of Rinderknecht \& Volanschi \cite{unparsedpatterns}.
Note that this work needed a small modification of the ReasonLIGO CST to include more information, see \url{https://gitlab.com/ligolang/ligo/-/merge_requests/785}.

\subsection{PascaLIGO dialects}
The analysis is of course made on the PascaLIGO CST. It is a simple fold, deducting a dialect when possible, and raising an error when two different dialects are detected.\\
I also added an option in the compiler to choose the dialect when decompiling to PascaLIGO, see \url{https://gitlab.com/ligolang/ligo/-/merge_requests/791}.

\section{Other contributions}
As I planned to work on decompiled ASTs, I made a change allowing the decompilation of typed ASTs see:
\begin{itemize}
\item \url{https://gitlab.com/ligolang/ligo/-/merge_requests/774}
\item \url{https://gitlab.com/ligolang/ligo/-/merge_requests/780}
\end{itemize}
However, the compilation process erases much information and the decompilation does not allow yet to recover them (for example, an \verb|if then else| clause is compiled to a pattern matching of the \verb|bool| structure and decompiled as such). Consequently, I decided to only analyze the original CST and not the decompiled one.

\section{Further work}
The linter is in a usable state. Some work remains yet to be done:
\begin{itemize}
\item Create a general set of rules for each LIGO flavor.
\item Improve the unparsing of each CST.
\item Improve the unused variable engine for a better approximation of the set of unused variables.
\item Integrate the linter to code editors.
\end{itemize}

\bibliographystyle{plain}
\bibliography{publications}{}
\end{document}